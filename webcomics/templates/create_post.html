{% extends "./layouts/base.html" %}
{% load static %}

{% block title %}Crear Post{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href='{% static "css/home_redesign.css" %}'>
<style>
    .form-container {
        max-width: 600px;
        margin: 40px auto;
        background: white;
        padding: 40px;
        border: 1px solid #ccc;
    }

    .form-container h1 {
        font-family: 'HeavyHeader', sans-serif;
        margin-bottom: 30px;
        text-transform: uppercase;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
    }

    .form-control,
    .form-select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .btn-submit {
        background-color: #111;
        color: #fff;
        border: none;
        padding: 12px 24px;
        font-weight: bold;
        text-transform: uppercase;
        cursor: pointer;
        width: 100%;
    }

    .btn-submit:hover {
        background-color: #333;
    }

    #image-preview {
        max-width: 100%;
        height: auto;
        margin-top: 15px;
        display: none;
        /* Hidden by default */
        border: 1px solid #ddd;
        padding: 5px;
    }

    /* 2D to 3D Conversion Overlay */
    #conversion-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        text-align: center;
    }

    .conversion-box {
        width: 90%;
        max-width: 500px;
        padding: 40px;
        background: #1a1a1a;
        border-radius: 20px;
        box-shadow: 0 0 50px rgba(197, 160, 89, 0.2);
        border: 1px solid #333;
    }

    .progress-container {
        width: 100%;
        height: 10px;
        background: #333;
        border-radius: 5px;
        margin: 30px 0;
        overflow: hidden;
    }

    #progress-bar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #c5a059, #ecc94b);
        transition: width 0.3s ease;
    }

    .preview-3d-wrap {
        perspective: 1000px;
        margin-bottom: 30px;
    }

    #preview-3d {
        width: 200px;
        height: 280px;
        object-fit: cover;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        animation: rotate3d 4s infinite linear;
        border-radius: 10px;
    }

    @keyframes rotate3d {
        0% {
            transform: rotateY(0deg) rotateX(0deg);
        }

        50% {
            transform: rotateY(180deg) rotateX(10deg);
        }

        100% {
            transform: rotateY(360deg) rotateX(0deg);
        }
    }

    .conversion-status {
        font-family: 'HeavyHeader', sans-serif;
        font-size: 1.5rem;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .error-msg {
        color: #ff4d4d;
        display: none;
    }

    .retry-btn {
        display: none;
        background: #ff4d4d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 20px;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="concept-container">
    <div class="form-container">
        <h1>Nuevo Post</h1>
        <form id="post-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="form-group">
                <label class="form-label">T√≠tulo</label>
                {{ form.nombre_del_manga }}
            </div>

            <div class="form-group">
                <label class="form-label">Descripci√≥n</label>
                {{ form.descripcion }}
            </div>

            <div class="form-group">
                <label class="form-label">Autor / Publicado Por</label>
                {{ form.publicado_por }}
            </div>

            <div class="form-group">
                <label class="form-label">Talla</label>
                {{ form.talla }}
            </div>

            <div class="form-group">
                <label class="form-label">G√©nero</label>
                {{ form.type_of_manga }}
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Precio de Venta ($)</label>
                {{ form.precio }}
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Costo de Adquisici√≥n ($)</label>
                {{ form.costo }}
            </div>

            <div class="form-group">
                <label class="form-label">Imagen (Portada)</label>
                {{ form.front_page }}
                <!-- Image Preview Element -->
                <img id="image-preview" src="#" alt="Vista previa de portada" />
            </div>


            <!-- Removed Manga File input as requested -->

            <button type="submit" class="btn-submit" id="submit-btn">Publicar</button>
        </form>
    </div>
</div>

<!-- 2D to 3D Conversion Overlay -->
<div id="conversion-overlay">
    <div class="conversion-box">
        <div class="preview-3d-wrap">
            <img id="preview-3d" src="" alt="3D Preview">
        </div>
        <div class="conversion-status" id="status-text">Convirtiendo a 3D...</div>
        <div class="progress-container">
            <div id="progress-bar"></div>
        </div>
        <div id="error-message" class="error-msg">
            <i class="bi bi-exclamation-triangle-fill"></i> Error en la conversi√≥n: Procesamiento fallido
        </div>
        <button type="button" class="retry-btn" id="retry-btn">CERRAR Y REINTENTAR</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.body.classList.add('home-page');

    // Image Preview Logic
    const frontPageInput = document.getElementById('id_front_page');
    const previewImage = document.getElementById('image-preview');
    const preview3D = document.getElementById('preview-3d');
    const form = document.getElementById('post-form');
    // Ensure image is required
    if (frontPageInput) frontPageInput.required = true;
    const overlay = document.getElementById('conversion-overlay');
    const progressBar = document.getElementById('progress-bar');
    const statusText = document.getElementById('status-text');
    const errorMsg = document.getElementById('error-message');
    const retryBtn = document.getElementById('retry-btn');

    if (frontPageInput) {
        frontPageInput.addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    preview3D.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });
    }



    // Real Upload and Processing logic
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        console.log('üöÄ Starting real upload process...');

        const formData = new FormData(form);
        const xhr = new XMLHttpRequest();

        // Show Overlay
        overlay.style.display = 'flex';
        errorMsg.style.display = 'none';
        retryBtn.style.display = 'none';
        statusText.style.display = 'block';
        statusText.innerText = 'PREPARANDO SUBIDA...';
        progressBar.style.width = '0%';
        progressBar.style.backgroundColor = '';

        // Track Upload Progress
        xhr.upload.addEventListener('progress', function (e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
                statusText.innerText = `SUBIENDO ARCHIVO: ${Math.round(percentComplete)}%`;

                if (percentComplete >= 100) {
                    statusText.innerText = 'SUBIDA COMPLETA. PROCESANDO IA Y 3D...';
                    progressBar.classList.add('progress-bar-striped', 'progress-bar-animated');
                }
            }
        });

        // Handle Completion
        xhr.onload = function () {
            if (xhr.status >= 200 && xhr.status < 300) {
                console.log('‚úÖ Upload and processing successful!');
                statusText.innerText = '¬°PUBLICADO CON √âXITO!';
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = '#4bb543';
                setTimeout(() => {
                    window.location.href = "{% url 'library' %}";
                }, 800);
            } else {
                handleError('Error en el servidor: ' + xhr.statusText);
            }
        };

        xhr.onerror = function () {
            handleError('Error de red al intentar subir.');
        };

        function handleError(msg) {
            console.error('‚ùå Upload error:', msg);
            statusText.style.display = 'none';
            errorMsg.style.display = 'block';
            errorMsg.innerText = msg;
            retryBtn.style.display = 'inline-block';
            progressBar.style.backgroundColor = '#ff4d4d';
        }

        xhr.open('POST', form.action, true);
        xhr.send(formData);
    });

</script>
{% endblock %}