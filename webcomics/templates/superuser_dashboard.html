{% extends "layouts/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Panel de Control | Surchaing Manga{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 100px auto 50px;
        padding: 40px;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 50px;
        border-bottom: 2px solid #111;
        padding-bottom: 20px;
    }

    .dashboard-title h1 {
        font-family: 'HeavyHeader', sans-serif;
        font-size: 3.5rem;
        text-transform: uppercase;
        margin: 0;
        line-height: 0.9;
    }

    .dashboard-subtitle {
        color: #666;
        font-size: 1.2rem;
        margin-top: 5px;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 30px;
        margin-bottom: 50px;
    }

    .stat-card {
        background: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        border: 1px solid #eee;
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        border-color: #111;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #888;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
        display: block;
    }

    .stat-value {
        font-family: 'HeavyHeader', sans-serif;
        font-size: 3rem;
        color: #111;
        line-height: 1;
    }

    .stat-trend {
        font-size: 0.9rem;
        margin-top: 10px;
        display: flex;
        align-items: center;
    }

    .trend-up {
        color: #155724;
        background: #d4edda;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: bold;
    }

    .trend-neutral {
        color: #856404;
        background: #fff3cd;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: bold;
    }

    .section-title {
        font-family: 'HeavyHeader', sans-serif;
        font-size: 2rem;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .section-title i {
        font-size: 1.5rem;
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 30px;
    }

    .action-card {
        background: #111;
        color: white;
        padding: 40px;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: block;
    }

    .action-card:hover {
        background: #333;
        transform: scale(1.02);
        color: white;
    }

    .action-icon {
        font-size: 3rem;
        margin-bottom: 20px;
        color: #ecc94b;
        /* Gold accent */
    }

    .action-title {
        font-family: 'HeavyHeader', sans-serif;
        font-size: 1.8rem;
        margin-bottom: 10px;
        text-transform: uppercase;
    }

    .action-desc {
        color: #ccc;
        font-size: 0.95rem;
    }

    /* Inventory Table Style */
    .inventory-preview {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #eee;
    }

    .table {
        width: 100%;
        margin-bottom: 0;
    }

    .table th {
        background: #f9f9f9;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.85rem;
        color: #555;
        border-bottom: 2px solid #eee;
        padding: 20px;
    }

    .table td {
        padding: 20px;
        vertical-align: middle;
        border-bottom: 1px solid #eee;
        font-size: 1rem;
    }

    .product-img-thumb {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 15px;
        background: #eee;
    }

    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        text-transform: uppercase;
    }

    .status-active {
        background: #e6fffa;
        color: #2c7a7b;
    }

    .status-low {
        background: #fffaf0;
        color: #c05621;
        background: #fff3cd;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: bold;
    }

    /* Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        backdrop-filter: blur(5px);
        align-items: center;
        justify-content: center;
    }

    .warehouse-modal {
        background: white;
        padding: 40px;
        border-radius: 15px;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    }

    .modal-title {
        font-family: 'HeavyHeader', sans-serif;
        font-size: 2rem;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #666;
        font-size: 0.9rem;
    }

    .form-control-custom:focus {
        border-color: var(--gold);
        outline: none;
    }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root {
        --gold: #C5A059;
        --dark: #111;
    }

    body {
        background-color: #f8f9fa;
    }

    .dashboard-header {
        background: #fff;
        padding: 40px;
        border-bottom: 1px solid #eee;
        margin-bottom: 40px;
    }

    .chart-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 30px;
        margin-bottom: 40px;
    }

    .chart-grid-full {
        width: 100%;
        margin-top: 30px;
    }

    .chart-card {
        background: #fff;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.02);
        display: flex;
        flex-direction: column;
        min-height: 400px;
    }

    .chart-container-inner {
        position: relative;
        flex: 1;
        width: 100%;
        min-height: 300px;
    }

    .chart-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Dashboard Responsiveness - MOVED TO END TO ENSURE OVERRIDE */
    @media (max-width: 1100px) {
        .dashboard-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .chart-grid {
            grid-template-columns: 1fr;
        }

        .actions-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
    }

    @media (max-width: 768px) {
        .dashboard-container {
            margin: 80px 15px 30px;
            padding: 0;
        }

        .dashboard-header {
            flex-direction: column;
            text-align: center;
            padding: 20px;
            margin-bottom: 30px;
        }

        .dashboard-header div[style*="text-align: right"] {
            text-align: center !important;
            margin-top: 20px;
        }

        .dashboard-title h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .dashboard-grid,
        .actions-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .stat-value {
            font-size: 2.2rem;
        }

        .stat-card,
        .action-card,
        .chart-card {
            padding: 20px;
        }

        .table-responsive-custom {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .inventory-preview {
            border-radius: 0;
            margin: 0 -15px;
            /* Bleed to edges */
            border-left: none;
            border-right: none;
        }

        .section-title {
            font-size: 1.5rem;
            padding: 0 15px;
        }
    }
</style>
{% endblock %}

{% block nav %}
{% include "components/static_header.html" %}
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <div class="dashboard-title">
            <h1>Panel de Control</h1>
            <div class="dashboard-subtitle">Gestión de Negocio - Ropa & Gorras Premium</div>
            <button id="enable-notifications-btn" class="btn btn-sm btn-outline-dark mt-2">
                <i class="bi bi-bell-fill"></i> Activar Notificaciones PC
            </button>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 0.9rem; color: #888;">FECHA</div>
            <div style="font-weight: bold; font-size: 1.2rem;">{% now "j F Y" %}</div>
        </div>
    </div>

    <!-- KPI Section: Mock data for business feel -->
    <div class="dashboard-grid">
        <div class="stat-card">
            <span class="stat-label">Ventas Totales</span>
            <div class="stat-value">${{ total_sales|intcomma }}</div>
            <div class="stat-trend"><span class="trend-neutral"><i class="bi bi-dash"></i> Actual</span> <span
                    style="margin-left: 8px; color: #999;">conectado</span></div>
        </div>
        <div class="stat-card" style="border-left: 4px solid #111;">
            <span class="stat-label">Warehouse (Físico)</span>
            <div class="stat-value">{{ total_warehouse }}</div>
            <div class="stat-trend"><span style="color: #666;">Total Unidades</span></div>
        </div>
        <div class="stat-card">
            <span class="stat-label">Digital (Catálogo)</span>
            <div class="stat-value">{{ stock_gorras|add:stock_prendas }}</div>
            <div class="stat-trend"><span style="color: #666;">Total Unidades</span></div>
        </div>
        <div class="stat-card">
            <span class="stat-label">Órdenes Activas</span>
            <div class="stat-value">{{ active_orders }}</div>
            <div class="stat-trend"><span class="trend-neutral"><i class="bi bi-dash"></i> Actual</span></div>
        </div>
    </div>

    <!-- Reports Section -->
    <h2 id="reportes-section" class="section-title" style="margin-top: 60px;"><i class="bi bi-graph-up-arrow"
            style="color: var(--gold);"></i>
        Reportes y Analítica Profesional</h2>

    <div class="chart-grid">
        <!-- Chart 1: Monthly Sales -->
        <div class="chart-card">
            <div class="chart-title"><i class="bi bi-bar-chart-fill" style="color: #4c51bf;"></i> Rendimiento Mensual de
                Ventas</div>
            <div class="chart-container-inner">
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <!-- Chart 2: Profit vs Loss -->
        <div class="chart-card">
            <div class="chart-title"><i class="bi bi-pie-chart-fill" style="color: #48bb78;"></i> Distribución de Margen
                y Costos</div>
            <div class="chart-container-inner">
                <canvas id="profitChart"></canvas>
            </div>
        </div>

        <!-- Chart 3: Seasonality -->
        <div class="chart-card">
            <div class="chart-title"><i class="bi bi-compass-fill" style="color: #ed8936;"></i> Análisis de Demanda
                Estacional</div>
            <div class="chart-container-inner">
                <canvas id="radarChart"></canvas>
            </div>
        </div>

        <!-- Chart 4: Trend / Area -->
        <div class="chart-card">
            <div class="chart-title"><i class="bi bi-lightning-charge-fill" style="color: #ecc94b;"></i> Tendencias de
                Compra y Festividades</div>
            <div class="chart-container-inner">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Chart 5: Warehouse Margins (Full Width) -->
    <div class="chart-grid-full">
        <div class="chart-card" style="min-height: 450px;">
            <div class="chart-title"><i class="bi bi-wallet2" style="color: #ed64a6;"></i> Margen de Ganancia Proyectado
                (Inversión en Almacén)</div>
            <div class="chart-container-inner">
                <canvas id="marginChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Inventory Comparison -->
    <h2 class="section-title" style="margin-top: 60px;"><i class="bi bi-arrow-left-right" style="color: #ecc94b;"></i>
        Comparativa de Inventarios</h2>
    <div class="inventory-preview" style="margin-bottom: 50px;">
        <table class="table">
            <thead>
                <tr>
                    <th>Categoría</th>
                    <th>Físico (Almacén)</th>
                    <th>Digital (Catálogo)</th>
                    <th>Diferencia</th>
                    <th>Acciones Almacén</th>
                </tr>
            </thead>
            <tbody>
                {% for stock in comparison %}
                <tr>
                    <td style="font-weight: bold;">{{ stock.category }}</td>
                    <td style="font-size: 1.2rem;">{{ stock.warehouse }}</td>
                    <td style="font-size: 1.2rem;">{{ stock.catalog }}</td>
                    <td>
                        {% if stock.status == 'missing' %}
                        <span class="status-badge" style="background: #fff5f5; color: #c53030;">FALTA ({{
                            stock.display_abs_diff }})</span>
                        {% elif stock.status == 'excess' %}
                        <span class="status-badge" style="background: #ebf8ff; color: #2b6cb0;">EXCESO ({{
                            stock.display_diff }})</span>
                        {% else %}
                        <span class="status-badge" style="background: #f0fff4; color: #2f855a;">OK</span>
                        {% endif %}
                    </td>
                    <td>
                        <button onclick="openWarehouseModal('{{ stock.category }}')" class="btn btn-sm btn-dark"><i
                                class="bi bi-plus"></i></button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Support Chats Section -->
    <h2 class="section-title" style="margin-top: 60px;"><i class="bi bi-chat-left-text-fill"
            style="color: var(--gold);"></i>
        Centro de Mensajes</h2>

    <div class="chat-tabs" style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="chat-tab-btn active" onclick="switchChatTab('support')" id="btn-tab-support">
            <i class="bi bi-robot"></i> ASISTENTE AI
        </button>
        <button class="chat-tab-btn" onclick="switchChatTab('dm')" id="btn-tab-dm">
            <i class="bi bi-bag-check-fill"></i> DMs DE PRODUCTOS
        </button>
    </div>

    <div class="inventory-preview" style="margin-bottom: 50px; background: #fff;">
        <div style="display: flex; height: 550px;">
            <!-- Chat List Support -->
            <div id="list-support" class="chat-sidebar-list"
                style="width: 300px; border-right: 1px solid #eee; overflow-y: auto; background: #fafafa;">
                {% for chat in support_chats %}
                <div class="chat-item" data-session="{{ chat.session_key }}" data-user="{{ chat.user|default:'' }}"
                    data-name="{{ chat.display_name }}" data-type="support" onclick="handleChatItemClick(this)"
                    style="padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; position: relative;">
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <div
                            style="width: 40px; height: 40px; border-radius: 50%; background: {% if chat.user %}#000{% else %}#ccc{% endif %}; display: flex; align-items: center; justify-content: center; color: #fff;">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <div style="flex: 1; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 800; color: #333; font-size: 0.9rem;">
                                    {{ chat.display_name }}
                                </span>
                                <small style="color: #999; font-size: 0.7rem;">{{ chat.last_msg_time|date:"H:i"
                                    }}</small>
                            </div>
                            <div
                                style="font-size: 0.75rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;">
                                {% if not chat.last_msg_is_admin %}
                                <span
                                    style="background: #25d366; color: #fff; padding: 2px 6px; border-radius: 10px; font-size: 0.6rem; font-weight: 900; margin-right: 5px;">NUEVO</span>
                                {% endif %}
                                {{ chat.last_msg_text|default:"(Sin mensaje)" }}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div style="padding: 20px; color: #999; text-align: center;">No hay chats de soporte.</div>
                {% endfor %}
            </div>

            <!-- Chat List DMs (Hidden initially) -->
            <div id="list-dm" class="chat-sidebar-list"
                style="width: 300px; border-right: 1px solid #eee; overflow-y: auto; background: #fafafa; display: none;">
                {% for chat in dm_chats %}
                <div class="chat-item" data-session="{{ chat.session_key }}" data-user="{{ chat.user|default:'' }}"
                    data-name="{{ chat.display_name }}" data-type="dm" onclick="handleChatItemClick(this)"
                    style="padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; position: relative;">
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <div
                            style="width: 40px; height: 40px; border-radius: 50%; background: #bfa37c; display: flex; align-items: center; justify-content: center; color: #fff;">
                            <i class="bi bi-cart-check-fill"></i>
                        </div>
                        <div style="flex: 1; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 800; color: #333; font-size: 0.9rem;">
                                    {{ chat.display_name }}
                                </span>
                                <small style="color: #999; font-size: 0.7rem;">{{ chat.last_msg_time|date:"H:i"
                                    }}</small>
                            </div>
                            <div
                                style="font-size: 0.75rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;">
                                {% if not chat.last_msg_is_admin %}
                                <span
                                    style="background: #25d366; color: #fff; padding: 2px 6px; border-radius: 10px; font-size: 0.6rem; font-weight: 900; margin-right: 5px;">NUEVO</span>
                                {% endif %}
                                {{ chat.last_msg_text|default:"(Sin mensaje)" }}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div style="padding: 20px; color: #999; text-align: center;">No hay mensajes directos.</div>
                {% endfor %}
            </div>

            <!-- Chat Content -->
            <div id="admin-chat-content" style="flex: 1; display: flex; flex-direction: column;">
                <div id="admin-chat-header"
                    style="padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: 900; background: #fff; display: flex; align-items: center; gap: 15px;">
                    <button class="btn btn-sm btn-outline-dark mobile-only" onclick="closeAdminChatMobile()">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <span id="admin-chat-header-text">Seleccionar una conversación</span>
                </div>
                <div id="admin-chat-messages"
                    style="flex: 1; padding: 20px; overflow-y: auto; background: #f8f9fa; display: flex; flex-direction: column; gap: 10px;">
                    <div class="text-center text-muted mt-5">
                        <i class="bi bi-chat-square-text fs-1"></i>
                        <p class="mt-2">Selecciona un chat para comenzar</p>
                    </div>
                </div>
                <div id="admin-chat-input-area"
                    style="padding: 15px; border-top: 1px solid #eee; display: none; gap: 10px; background: #fff;">
                    <input type="text" id="admin-chat-input" class="form-control-custom" placeholder="Mensaje..."
                        style="flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 10px; font-size: 0.9rem;"
                        onkeypress="handleAdminChatKey(event)">
                    <button class="btn btn-dark" onclick="sendAdminReply()"
                        style="padding: 0 15px; font-size: 0.8rem; font-weight: 800;">ENVIAR</button>
                    <input type="hidden" id="current-chat-session">
                    <input type="hidden" id="current-chat-user">
                    <input type="hidden" id="current-chat-type">
                </div>
            </div>
        </div>
    </div>

    <style>
        .chat-item:hover {
            background: #f0f0f0;
        }

        .chat-item.active {
            background: #fff;
            border-left: 4px solid var(--gold);
        }

        /* WhatsApp Style Refinement */
        #admin-chat-messages {
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-color: #e5ddd5;
            background-blend-mode: overlay;
        }

        .wa-bubble {
            position: relative;
            max-width: 70%;
            padding: 8px 12px 20px;
            border-radius: 7.5px;
            margin-bottom: 2px;
            font-size: 0.9rem;
            line-height: 1.4;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .wa-bubble.admin {
            align-self: flex-end;
            background-color: #dcf8c6;
            border-top-right-radius: 0;
        }

        .wa-bubble.user {
            align-self: flex-start;
            background-color: #ffffff;
            border-top-left-radius: 0;
        }

        .wa-time {
            position: absolute;
            bottom: 4px;
            right: 8px;
            font-size: 0.7rem;
            color: rgba(0, 0, 0, 0.45);
        }

        /* Chat Tabs */
        .chat-tab-btn {
            background: #eee;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.3s;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-tab-btn.active {
            background: #000;
            color: #fff;
        }

        .chat-tab-btn:hover:not(.active) {
            background: #ddd;
        }

        .mobile-only {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-only {
                display: block;
            }

            .chat-tabs {
                flex-direction: row;
                overflow-x: auto;
                padding-bottom: 5px;
            }

            .chat-tab-btn {
                flex: 1;
                white-space: nowrap;
                font-size: 0.7rem;
                padding: 12px 10px;
                justify-content: center;
                flex-direction: column;
                gap: 5px;
            }

            .chat-tab-btn i {
                font-size: 1.2rem;
            }

            .chat-sidebar-list {
                width: 100% !important;
                border-right: none !important;
            }

            #admin-chat-content {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 10001;
                background: #fff;
                display: none !important;
                /* Managed by JS */
            }

            #admin-chat-content.show-mobile {
                display: flex !important;
            }

            .inventory-preview {
                margin-left: -15px;
                margin-right: -15px;
                border-radius: 0;
            }

            #admin-chat-messages {
                padding: 10px;
            }

            .wa-bubble {
                max-width: 85%;
            }
        }
    </style>

    <!-- Operations Section -->
    <h2 class="section-title"><i class="bi bi-lightning-charge-fill" style="color: #ecc94b;"></i> Acciones Rápidas</h2>
    <div class="actions-grid">
        <a href="{% url 'create_post' %}" class="action-card">
            <i class="bi bi-plus-circle action-icon"></i>
            <h3 class="action-title">Nuevo Producto</h3>
            <p class="action-desc">Agregar gorras o prendas nuevas al catálogo.</p>
        </a>
        <a href="{% url 'team' %}" class="action-card">
            <i class="bi bi-people-fill action-icon"></i>
            <h3 class="action-title">Gestionar Equipo</h3>
            <p class="action-desc">Ver y configurar roles del personal.</p>
        </a>
        <a href="#reportes-section" class="action-card">
            <i class="bi bi-bar-chart-fill action-icon"></i>
            <h3 class="action-title">Reportes</h3>
            <p class="action-desc">Ver análisis de ventas y stock.</p>
        </a>
    </div>

    <!-- Inventory Preview (Using Real Manga/Product Data) -->
    <h2 class="section-title" style="margin-top: 60px;"><i class="bi bi-box-seam-fill"></i> Inventario Reciente</h2>
    <div class="inventory-preview">
        <table class="table">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Categoría</th>
                    <th>Precio</th>
                    <th>Subido</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for item in latest_products %}
                <tr>
                    <td>
                        <div style="display: flex; align-items: center;">
                            {% if item.front_page %}
                            <img src="{{ item.front_page.url }}" class="product-img-thumb" alt="Product">
                            {% else %}
                            <div class="product-img-thumb"></div>
                            {% endif %}
                            <span style="font-weight: bold;">{{ item.nombre_del_manga }}</span>
                        </div>
                    </td>
                    <td>{{ item.type_of_manga }}</td>
                    <td><strong>${{ item.precio }}</strong></td>
                    <td>{{ item.fecha_de_carga|date:"d M Y" }}</td>
                    <td>
                        {% if item.vendido %}
                        <span class="status-badge" style="background: #eee; color: #999;">Vendido</span>
                        {% else %}
                        <span class="status-badge status-active">En Stock</span>
                        {% endif %}
                    </td>
                    <td>

                        <a href="{% url 'delete_post' item.id %}" class="btn btn-sm btn-outline-danger"
                            onclick="return confirm('¿Eliminar este producto?');"><i class="bi bi-trash"></i></a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align: center; color: #999;">No hay productos recientes.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<!-- New Modal HTML -->
<div id="warehouseModalOverlay" class="modal-overlay">
    <div class="warehouse-modal">
        <h2 class="modal-title">Añadir Stock: <span id="modalTitle" style="color: var(--gold);">Categoría</span></h2>
        <form id="warehouseForm">
            <input type="hidden" name="category" id="modalCategory">

            <div class="form-group">
                <label>Vincular con Producto Digital (Catálogo)</label>
                <select name="manga_id" id="digitalProductSelect" class="form-control-custom"
                    onchange="onDigitalProductChange()">
                    <option value="">-- Seleccionar Producto Digital --</option>
                </select>
                <small style="color: #888;">Esto autocompletará el precio de venta.</small>
            </div>

            <div class="form-group">
                <label>¿Cuántas unidades vas a agregar?</label>
                <input type="number" name="quantity" class="form-control-custom" value="1" min="1" required>
            </div>

            <div class="form-group">
                <label>¿Cuánto te costó cada una? (Precio de compra)</label>
                <input type="number" step="0.01" name="cost" class="form-control-custom" placeholder="0.00" required>
            </div>

            <div class="form-group">
                <label>¿A cuánto planeas venderla? (Precio final)</label>
                <input type="number" step="0.01" name="price" id="modalPrice" class="form-control-custom"
                    placeholder="0.00" required>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button type="submit" class="btn btn-dark" style="flex: 2; padding: 15px;">ACTUALIZAR
                    INVENTARIO</button>
                <button type="button" onclick="closeWarehouseModal()" class="btn btn-outline-dark"
                    style="flex: 1;">CANCELAR</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Data from Django Context
    const salesLabels = {{ chart_sales_labels| safe }};
    const salesData = {{ chart_sales_data| safe }};
    const pieLabels = {{ chart_pie_labels| safe }};
    const pieData = {{ chart_pie_data| safe }};
    const radarLabels = {{ chart_radar_labels| safe }};
    const radarData = {{ chart_radar_data| safe }};
    const trendLabels = {{ chart_trend_labels| safe }};
    const trendData = {{ chart_trend_data| safe }};
    const marginLabels = {{ chart_margin_labels| safe }};
    const marginData = {{ chart_margin_data| safe }};
    const digitalProducts = {{ all_digital_products| safe }};

    // Helper for gradients
    function createGradient(ctx, colorStart, colorEnd) {
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, colorStart);
        gradient.addColorStop(1, colorEnd);
        return gradient;
    }

    // 1. Monthly Sales Chart (Line with Area Fill)
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: salesLabels,
            datasets: [{
                label: 'Ventas ($)',
                data: salesData,
                borderColor: '#4c51bf',
                backgroundColor: createGradient(salesCtx, 'rgba(76, 81, 191, 0.4)', 'rgba(76, 81, 191, 0)'),
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointBackgroundColor: '#4c51bf',
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', padding: 12, borderRadius: 8 }
            },
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                x: { grid: { display: false } }
            }
        }
    });

    // 2. Profit vs Loss (Doughnut with segments)
    new Chart(document.getElementById('profitChart'), {
        type: 'doughnut',
        data: {
            labels: pieLabels,
            datasets: [{
                data: pieData,
                backgroundColor: ['#48bb78', '#f56565', '#a0aec0'],
                hoverBackgroundColor: ['#38a169', '#e53e3e', '#718096'],
                borderWidth: 0,
                hoverOffset: 12
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '75%',
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
            }
        }
    });

    // 3. Seasonality (Radar)
    new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
            labels: radarLabels,
            datasets: [{
                label: 'Movimiento de Stock',
                data: radarData,
                backgroundColor: 'rgba(237, 137, 54, 0.2)',
                borderColor: '#ed8936',
                pointBackgroundColor: '#ed8936',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: { r: { beginAtZero: true } }
        }
    });

    // 4. Trend Chart (Bar with Roundness)
    new Chart(document.getElementById('trendChart'), {
        type: 'bar',
        data: {
            labels: trendLabels,
            datasets: [{
                label: 'Ventas',
                data: trendData,
                backgroundColor: '#ecc94b',
                hoverBackgroundColor: '#d69e2e',
                borderRadius: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid: { display: false } } }
        }
    });

    // 5. Projected Margins
    new Chart(document.getElementById('marginChart'), {
        type: 'bar',
        data: {
            labels: marginLabels,
            datasets: [{
                label: 'Monto ($)',
                data: marginData,
                backgroundColor: ['#4299e1', '#48bb78', '#ed64a6'],
                borderRadius: 10
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } } }
        }
    });

    // Modal Logic
    function openWarehouseModal(category) {
        document.getElementById('modalCategory').value = category;
        document.getElementById('modalTitle').innerText = category;

        // Filter digital products by category
        const catalogSelect = document.getElementById('digitalProductSelect');
        catalogSelect.innerHTML = '<option value="">-- Seleccionar Producto Digital --</option>';

        const filtered = digitalProducts.filter(p => p.type_of_manga === category);
        filtered.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.dataset.price = p.precio;
            opt.textContent = `${p.nombre_del_manga} ($${p.precio})`;
            catalogSelect.appendChild(opt);
        });

        document.getElementById('warehouseModalOverlay').style.display = 'flex';
    }

    function onDigitalProductChange() {
        const select = document.getElementById('digitalProductSelect');
        const selectedOption = select.options[select.selectedIndex];
        if (selectedOption && selectedOption.dataset.price) {
            document.getElementById('modalPrice').value = selectedOption.dataset.price;
        } else {
            document.getElementById('modalPrice').value = '';
        }
    }

    function closeWarehouseModal() {
        document.getElementById('warehouseModalOverlay').style.display = 'none';
        document.getElementById('warehouseForm').reset();
    }

    // Attach listener using DOMContentLoaded or just here since it's at the end
    document.getElementById('warehouseForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        formData.append('action', 'add');

        fetch("{% url 'update_warehouse' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo actualizar'));
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error de conexión al servidor');
            });
    });
    // Admin Chat Logic
    let activeSession = '';
    let activeUser = '';
    let activeType = 'support';

    function handleAdminChatKey(e) { if (e.key === 'Enter') sendAdminReply(); }

    function switchChatTab(tab) {
        activeType = tab;
        document.querySelectorAll('.chat-tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.chat-sidebar-list').forEach(list => list.style.display = 'none');

        if (tab === 'support') {
            document.getElementById('btn-tab-support').classList.add('active');
            document.getElementById('list-support').style.display = 'block';
        } else {
            document.getElementById('btn-tab-dm').classList.add('active');
            document.getElementById('list-dm').style.display = 'block';
        }

        // Reset chat content
        document.getElementById('admin-chat-header-text').innerText = 'Seleccionar una conversación';
        document.getElementById('admin-chat-input-area').style.display = 'none';
        document.getElementById('admin-chat-messages').innerHTML = `
            <div class="text-center text-muted mt-5">
                <i class="bi bi-chat-square-text fs-1"></i>
                <p class="mt-2">Selecciona un chat para comenzar</p>
            </div>`;
    }

    function handleChatItemClick(el) {
        const session_key = el.dataset.session;
        const user_id = el.dataset.user;
        const name = el.dataset.name;
        const type = el.dataset.type;
        openAdminChat(session_key, user_id, name, type, el);
    }

    function closeAdminChatMobile() {
        document.getElementById('admin-chat-content').classList.remove('show-mobile');
    }

    async function openAdminChat(session_key, user_id, name, type, el) {
        activeSession = session_key;
        activeUser = user_id;

        const headerText = document.getElementById('admin-chat-header-text');
        headerText.innerText = name;
        if (window.innerWidth > 768) {
            headerText.innerText = `[${type.toUpperCase()}] Chateando con: ${name}`;
        }

        document.getElementById('admin-chat-input-area').style.display = 'flex';
        document.getElementById('current-chat-session').value = session_key;
        document.getElementById('current-chat-user').value = user_id;
        document.getElementById('current-chat-type').value = type;

        // Visual selection
        document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
        el.classList.add('active');

        // Mobile transition
        if (window.innerWidth <= 768) {
            document.getElementById('admin-chat-content').classList.add('show-mobile');
        }

        loadAdminMessages();
    }

    async function loadAdminMessages() {
        if (!activeSession && !activeUser) return;

        try {
            const isDm = activeType === 'dm';
            const resp = await fetch(`/chat/get/?s_key=${activeSession}&u_id=${activeUser}&is_dm=${isDm}`);
            const data = await resp.json();
            const container = document.getElementById('admin-chat-messages');
            container.innerHTML = '';

            data.messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `wa-bubble ${msg.is_from_admin ? 'admin' : 'user'}`;

                const text = document.createElement('span');
                text.innerText = msg.message;
                div.appendChild(text);

                const time = document.createElement('span');
                time.className = 'wa-time';
                time.innerText = msg.timestamp;
                div.appendChild(time);

                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        } catch (e) { console.error("Admin chat load error", e); }
    }

    async function sendAdminReply() {
        const input = document.getElementById('admin-chat-input');
        const msg = input.value.trim();
        if (!msg) return;

        input.value = '';
        const formData = new FormData();
        formData.append('message', msg);
        formData.append('session_key', activeSession);
        formData.append('user_id', activeUser);
        formData.append('is_dm', activeType === 'dm');

        try {
            await fetch('/chat/reply/', {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });
            loadAdminMessages();
        } catch (e) { console.error("Reply error", e); }
    }

    // Notifications for Mobile App (APK)
    let lastNotifiedMsgId = 0;

    async function checkDmNotifications() {
        if (!window.ReactNativeWebView) return; // Only if inside Expo mobile app

        try {
            const resp = await fetch('/chat/dm/notifications/');
            const data = await resp.json();

            if (data.unread_count > 0) {
                const latest = data.notifications[data.notifications.length - 1];
                if (latest.id > lastNotifiedMsgId) {
                    lastNotifiedMsgId = latest.id;
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'notification',
                        title: 'Nuevo Mensaje de Producto',
                        body: `${latest.sender}: ${latest.message}`,
                        data: { msg_id: latest.id }
                    }));
                }
            }
        } catch (e) { console.error("Notification check error", e); }
    }

    // Polling for admin
    setInterval(() => {
        if (document.visibilityState === 'visible') {
            if (activeSession || activeUser) {
                loadAdminMessages();
            }
            checkDmNotifications();
        }
    }, 5000);

    // Push Token Registration (Injected from Mobile App)
    window.registerToken = function (token) {
        console.log("Registered Token received:", token);
        fetch('/api/register-push-token/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ token: token })
        }).then(res => res.json())
            .then(data => console.log("Token Registration:", data))
            .catch(err => console.error("Token Registration Error:", err));
    };

    // Check if token was already injected before this script ran
    if (window.EXPO_PUSH_TOKEN) {
        window.registerToken(window.EXPO_PUSH_TOKEN);
    }
</script>
<script src="{% static 'js/notifications.js' %}"></script>
{% endblock %}